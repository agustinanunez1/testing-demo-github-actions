name: CI + Deploy Manual

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:
    inputs:
      hook_url:
        description: "Pegá la URL del Deploy Hook de Render acá"
        required: true

jobs:

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Descargar código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ejecutar tests
        run: pytest -v

  deploy:
    # Este job SOLO se ejecuta cuando usás el botón "Run workflow"
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Ocultar hook en logs
        run: echo "::add-mask::${{ github.event.inputs.hook_url }}"

      - name: Disparar deploy en Render
        run: |
          set -e
          HTTP_CODE=$(curl -s -o /tmp/resp.json -w "%{http_code}" -X POST "${{ github.event.inputs.hook_url }}")
          echo "HTTP_CODE=$HTTP_CODE"
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Respuesta de Render:" && cat /tmp/resp.json || true
            exit 1
          fi
          echo "✅ Deploy completado correctamente"
